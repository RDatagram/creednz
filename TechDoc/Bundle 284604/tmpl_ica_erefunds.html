<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Required meta tags -->
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

		<!-- Bootstrap CSS -->
		<link
			rel="stylesheet"
			href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
			integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
			crossorigin="anonymous"
		/>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
		<link rel="stylesheet" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.min.css" />
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
		<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

		<style>
			.ica-label {
				font-weight: bold;
				font-size: 10px !important;
				text-transform: uppercase;
				text-align: center;
			}
			.ica-refund-label {
				font-weight: bold;
				font-size: 14px !important;
				text-transform: uppercase;
				color: #304768;
			}
			.input-size {
				font-weight: bold;
				font-size: 14px !important;
			}
			.override-ul {
				list-style-type: none !important;
				margin-left: 0px !important;
			}
			#erefunds_wrapper {
				width: 100% !important;
			}
			.list-group-item {
				list-style-type: none !important;
			}

			#notification {
				display: none;
			}
		</style>

		<title>iCA eRefunds</title>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row pt-2 pb-2 border border-light rounded" style="background: #f5f5f5" id="groupHeaderButtons">
				<div class="col-6">
					<button type="button" class="ica-label btn btn-primary btn-sm header-button" id="submitbutton" onclick="createPayments()">
						Submit
					</button>
					<button type="button" class="ica-label btn btn-danger btn-sm header-button" id="resetform" onclick="resetForm()">Reset</button>

					<button type="button" class="ica-label btn btn-secondary btn-sm header-button" id="downloadcsv" onclick="downloadCSV()">
						Download CSV
					</button>
					<i id="spinnerreload" class="fa fa-circle-o-notch fa-spin fa-fw fa-2x" style="display: none"></i>
				</div>
			</div>
			<div class="row mb-2 pt-2 pb-2 border border-light rounded" style="background: #egegeg" id="groupFilters">
				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Date</b>
					<input
						style="border: 1px solid #d3d3d3; font-size: 11px !important"
						class="form-inline form-control-sm input-size"
						id="dateFilter"
						name="dateFilter"
						value=""
					/>
				</div>
				<div class="col-2">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Bank Account*</b>
					<select class="form-control form-control-sm input-size" id="bankaccountFilter" onchange="reload(); updateSub()">
						{{#each accounts}}
						<option
							data-internalid="{{id}}"
							data-subsidiary="{{subsidiary}}"
							data-subsidiarytext="{{subsidiaryname}}"
							value="{{id}}"
							{{selected}}
						>
							{{name}}
						</option>
						{{/each}}
					</select>
				</div>
				<div class="col-2">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Subsidiary</b>
					<br />
					<input class="form-control form-control-sm input-size" type="text" disabled value="" id="subsidiarylabel" />
				</div>
			</div>

			<div class="row mb-2 pt-2 pb-2 border border-light rounded" style="background: #egegeg" id="groupFilters2">
				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Start Date</b>
					<input
						style="border: 1px solid #d3d3d3; font-size: 11px !important"
						class="form-inline form-control-sm input-size"
						id="startdate"
						name="startdate"
						value=""
						onchange="reload()"
					/>
					<!-- <b class="text-uppercase" style="font-size: 11px; color: #607798">A/R Account</b>
					<select class="form-control form-control-sm input-size" id="araccountFilter" onchange="reload()">
						<option value="">-</option>
						{{#each araccounts}}
						<option value="{{id}}">{{name}}</option>
						{{/each}}
					</select> -->
				</div>
				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">End Date</b>
					<input
						style="border: 1px solid #d3d3d3; font-size: 11px !important"
						class="form-inline form-control-sm input-size"
						id="enddate"
						name="enddate"
						value=""
						onchange="reload()"
					/>
				</div>
				<div class="col-5"></div>
				<div class="col-3">
					<div class="card">
						<ul class="list-group list-group-flush override-ul">
							<li class="list-group-item">
								<b class="text-uppercase" style="font-size: 11px; color: #607798">Total Number of refunds selected</b>
								<span id="refundcount" class="float-right ica-refund-label">-</span>
							</li>
							<li class="list-group-item">
								<b class="text-uppercase" style="font-size: 11px; color: #607798">Total Amount of Refunds</b>
								<span id="refundamount" class="float-right ica-refund-label">-</span>
							</li>
						</ul>
					</div>
				</div>
			</div>

			<div class="row mb-2 pt-2 pb-2 border border-light rounded" style="background: #egegeg" id="groupFilters3">
				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Payment Method</b>
					<select class="form-control form-control-sm input-size" id="paymentmethodFilter" onchange="reload()">
						<option value="">-</option>
						{{#each paymentmethods}}
						<option value="{{id}}">{{text}}</option>
						{{/each}}
					</select>
				</div>

				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Buyer Category</b>
					<select class="form-control form-control-sm input-size" id="categoryFilter" onchange="reload()">
						{{#each categories}}
						<option data-internalid="{{id}}" value="{{id}}">{{text}}</option>
						{{/each}}
					</select>
				</div>

				<div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Currency</b>
					<select class="form-control form-control-sm" id="currencyFilter" onchange="reload()">
						{{#each currencies}}
						<option data-internalid="{{id}}" value="{{id}}">{{text}}</option>
						{{/each}}
					</select>
				</div>
				<!-- <div class="col-2" id="groupSubFilter">
					<b class="text-uppercase" style="font-size: 11px; color: #607798">Location</b>
					<select class="form-control form-control-sm" id="locationFilter" onchange="reload()">
						{{#each locations}}
						<option data-internalid="{{id}}" value="{{id}}">{{text}}</option>
						{{/each}}
					</select>
				</div> -->
			</div>

			<div class="row" id="main-table">
				<table id="erefunds" class="table table-striped table-hover table-bordered table-sm">
					<thead style="background: #c5c5c5 !important">
						<tr>
							<th scope="col">
								<input type="checkbox" style="margin: 0px; padding: 0px; line-height: 0px" onchange="selectAll(this)" />
							</th>
							<th class="ica-label" scope="col">Date</th>
							<th class="ica-label" scope="col">Type</th>
							<th class="ica-label" scope="col">Payment Method</th>
							<th class="ica-label" scope="col">Customer Name</th>
							<th class="ica-label" scope="col">Reference Number / Transaction ID</th>
							<th class="ica-label" scope="col">Memo</th>
							<th class="ica-label" scope="col">Currency</th>
							<th class="ica-label" scope="col">Balance</th>
							<!-- <th class="ica-label" scope="col">Consolidated Balance</th> -->
							<th class="ica-label" scope="col">Amount Due</th>
						</tr>
					</thead>
					<tbody id="data">
						<!-- <tr id="data"></tr>                 -->
						{{#each transactions}}

            
						<tr>
							<th scope="row">
								<input
									class="cbdata"
									type="checkbox"
									id="cb_{{[Internal ID].id}}"
									data-internalid="{{[Internal ID].id}}"
									data-tranid="{{tranid.id}}"
									tranid
									onclick="updateHeaderValues()"
								/>
							</th>
							<td>{{Date.id}}</td>
							<td>{{Type.text}}</td>
							<td>{{[Payment Method].text}}</td>
							<td style="text-align: center"><a href="{{entityurl}}" target="_blank">{{[Customer Name].text}}</a></td>
							<td><a href="{{txnurl}}" target="_blank">{{tranid.id}}</a></td>
							<td>{{[Memo (Main)].id}}</td>
							<td>{{Currency.text}}</td>
							<td>{{balance.id}}</td>
							
							<td>
								<input
									disabled
									class="form-control form-control-sm input-size"
									type="number"
									data-max="{{Amount.id}}"
									value="{{Amount.id}}"
									id="amt_{{[Internal ID].id}}"
									onchange="checkMaxValue(this); updateHeaderValues()"
								/>
							</td>
						</tr>

						{{/each}}
            <!-- <td>{{consolidatebalance.id}}</td> -->
					</tbody>
				</table>
			</div>

			<div class="row pt-2 pb-2 border border-light rounded" style="background: #f5f5f5" id="groupFooterButtons">
				<div class="col-6">
					<button type="button" class="ica-label btn btn-primary btn-sm header-button" id="submitbutton" onclick="createPayments()">
						Submit
					</button>
					<button type="button" class="ica-label btn btn-danger btn-sm header-button" id="resetform" onclick="resetForm()">Reset</button>
					<button type="button" class="ica-label btn btn-secondary btn-sm header-button" id="downloadcsv" onclick="downloadCSV()">
						Download CSV
					</button>
				</div>
			</div>

			<div id="notification">
				<div class="row pb-2">
					<div class="col-6">
						<b class="h6">The following Customer Refunds are being processed:</b>
					</div>
				</div>
				<div class="row pt-2 pb-2">
					<div class="col-6">
						<ul class="list-group" id="refund-list"></ul>
					</div>
				</div>

				<div class="row pb-2">
					<div class="col-6">
						<b class="h6">You will receive an email once done.</b>
					</div>
				</div>

				<div class="row pt-2 pb-2 border border-light rounded" style="background: #f5f5f5" id="submitFooter">
					<div class="col-6">
						<!-- <button type="button" class="ica-label btn btn-primary btn-sm header-button" id="reloadpage" onclick="reloadPage()">
                                                        Reload Page
                                                </button> -->
					</div>
				</div>
			</div>
		</div>

		<!-- Optional JavaScript -->
		<!-- jQuery first, then Popper.js, then Bootstrap JS -->
		<script
			src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
			integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
			crossorigin="anonymous"
		></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js"></script>

		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
			integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
			crossorigin="anonymous"
		></script>
		<script
			src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
			integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
			crossorigin="anonymous"
		></script>
		<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script>
		<script src="https://cdn.datatables.net/plug-ins/1.10.20/sorting/natural.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

		<script>
			$(document).ready(function () {
				require(['N/url', 'N/runtime', 'N/ui/dialog', 'N/https', 'N/ui/message']);

				$('input[name="dateFilter"]').daterangepicker(
					{
						singleDatePicker: true,
						autoUpdateInput: false,
						autoApply: true,
					},
					function (chosen_date) {
						var runtime = require('N/runtime');
						var dpf = runtime.getCurrentUser().getPreference({
							name: 'DATEFORMAT',
						});
						var d = returnProperDateFormat(dpf);

						$('input[name="dateFilter"]').val(moment(chosen_date).format(d));
					}
				);

				$('input[name="startdate"]').daterangepicker(
					{
						singleDatePicker: true,
						autoUpdateInput: false,
						autoApply: true,
					},
					function (chosen_date) {
						var runtime = require('N/runtime');
						var dpf = runtime.getCurrentUser().getPreference({
							name: 'DATEFORMAT',
						});
						var d = returnProperDateFormat(dpf);

						$('input[name="startdate"]').val(moment(chosen_date).format(d));
						reload();
					}
				);
				$('input[name="enddate"]').daterangepicker(
					{
						singleDatePicker: true,
						autoUpdateInput: false,
						autoApply: true,
					},
					function (chosen_date) {
						var runtime = require('N/runtime');
						var dpf = runtime.getCurrentUser().getPreference({
							name: 'DATEFORMAT',
						});
						var d = returnProperDateFormat(dpf);
						$('input[name="enddate"]').val(moment(chosen_date).format(d));
						reload();
					}
				);

				$('#erefunds').DataTable();

				setTimeout(function () {
					var runtime = require('N/runtime');
					var dpf = runtime.getCurrentUser().getPreference({
						name: 'DATEFORMAT',
					});
					var d = returnProperDateFormat(dpf);
					$('#dateFilter').val(moment().format(d));
					updateSub();
				}, 1000);
			});

			function createPayments() {
				var ns = loadModules();
				// var context = nlapiGetContext();

				var bf = $('#bankaccountFilter').val();
				if (!bf) {
					ns.dialog.alert({
						title: 'Mandatory Field is Required',
						message: 'You need to select a bank account to proceed.',
					});
					return;
				}
				var subsidiary = $('#bankaccountFilter').find(':selected').data('subsidiary');

				var arrPaymentsSelected = [];
				var checked = $('.cbdata:checkbox:checked');
				for (var i = 0; i < checked.length; i++) {
					var internalid = $('#' + checked[i].id).data('internalid');
					var tranid = $('#' + checked[i].id).data('tranid');
					var amount = jQuery('#amt_' + internalid).val();
					arrPaymentsSelected.push({
						internalid: internalid,
						tranid: tranid,
						amount: amount,
					});
				}
				console.log(arrPaymentsSelected);

				if (arrPaymentsSelected.length == 0) {
					ns.dialog.alert({
						title: 'NOTE',
						message: 'Please select at least one record.',
					});
					return;
				}

				var filters = {
					paymentIds: JSON.stringify(arrPaymentsSelected),
				};
				var pageFilters = {
					startdate: $('#startdate').val(),
					enddate: $('#enddate').val(),
					araccountFilter: $('#araccountFilter').val(),
					bankaccountFilter: $('#bankaccountFilter').val(),
					paymentmethodFilter: $('#paymentmethodFilter').val(),
					categoryFilter: $('#categoryFilter').val(),
					currencyFilter: $('#currencyFilter').val(),
					locationFilter: $('#locationFilter').val(),
					dateFilter: $('#dateFilter').val(),
					subsidiary: subsidiary,
				};
				console.log(pageFilters);

				// var scriptParameters = {
				// 	baseSavedSearch: "{{basesavedsearch}}" || "",
				// 	fileNamePrefix: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_fn_prefix") || "",
				// 	folderID: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_folder_id") || "",
				// 	connectorFolderID: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_cf_id") || "",
				// 	sendSummaryEmail: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_send_file") || "",
				// 	//to add
				// 	WFNoAccountInformation: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_wfnai") || "",
				// 	wireFees: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_wirefees") || "",
				// 	vendorOrigMsgType: ns.runtime.getCurrentScript().getParameter("custscript_ica_erefunds_vomt") || "",
				// };

				var scriptParameters = {
					baseSavedSearch: '{{basesavedsearch}}' || '',
					fileNamePrefix: '{{sp.fileNamePrefix}}' || '',
					folderID: '{{sp.folderID}}' || '',
					connectorFolderID: '{{sp.connectorFolderID}}' || '',
					sendSummaryEmail: '{{sp.sendSummaryEmail}}' || '',
					WFNoAccountInformation: '{{sp.WFNoAccountInformation}}' || '',
					wireFees: '{{sp.wireFees}}' || '',
					vendorOrigMsgType: '{{sp.vendorOrigMsgType}}' || '',
          includeCheckZip: '{{sp.includeCheckZip}}',
          checkZipDeploymentID: '{{sp.checkZipDeploymentID}}',
          checkZipColumns: '{{sp.checkZipColumns}}',
          companyId: '{{sp.companyId}}' || 'Company'
				};

				console.log(scriptParameters);

				var link = ns.url.resolveScript({
					scriptId: 'customscript_ica_erefunds_service',
					deploymentId: 'customdeploy_ica_erefunds_service',
					params: {
						action: 'deploymapreduce',
						filters: JSON.stringify(filters),
						pageFilters: JSON.stringify(pageFilters),
						scriptParameters: JSON.stringify(scriptParameters),
					},
				});

				console.log(link);

				var link = ns.url.resolveScript({
					scriptId: 'customscript_ica_erefunds_service',
					deploymentId: 'customdeploy_ica_erefunds_service',
					params: {
						action: 'deploymapreduce',
						filters: JSON.stringify(filters),
						pageFilters: JSON.stringify(pageFilters),
						scriptParameters: JSON.stringify(scriptParameters),
					},
				});

				ns.https.get
					.promise({
						url: link,
					})
					.then(function (response) {
						var myMsg = ns.message.create({
							title: 'Backend Processing Initiated',
							message: 'A script has been deployed to update payments, and create xml file.',
							type: ns.message.Type.CONFIRMATION,
						});

						myMsg.show({
							duration: 5000,
						});

						$('#groupFilters').hide();
						$('#groupFilters').hide();
						$('#groupFilters2').hide();
						$('#groupFilters3').hide();
						$('#main-table').hide();
						$('#groupHeaderButtons').hide();
						$('#groupFooterButtons').hide();

						$('#notification').show();
						for (var i = 0; i < arrPaymentsSelected.length; i++) {
              var label = arrPaymentsSelected[i].tranid || arrPaymentsSelected[i].internalid;
							$('#refund-list').append(
								'<li class="list-group-item"><a target="_blank" href="/app/accounting/transactions/custrfnd.nl?id=' +
									arrPaymentsSelected[i].internalid +
									'">' +
									label +
									'</a></li>'
							);
						}

						//update ul

						return;
					});
			}

			function loadModules() {
				return {
					url: require('N/url'),
					runtime: require('N/runtime'),
					dialog: require('N/ui/dialog'),
					https: require('N/https'),
					message: require('N/ui/message'),
				};
			}

			function reloadPage() {
				window.location.reload();
			}

			function updateSub() {
				$('#subsidiarylabel').val($('#bankaccountFilter option:selected').data('subsidiarytext'));
			}

			function returnProperDateFormat(d) {
				if (d == 'D-Mon-YYYY') return 'D-MMM-YYYY';
				else if (d == 'D-Mon-YYYY') return 'D-MMM-YYYY';
				else if (d == 'DD-Mon-YYYY') return 'DD-MMM-YYYY';
				else if (d == 'D-MONTH-YYYY') return 'D-MMMM-YYYY';
				else if (d == 'DD-MONTH-YYYY') return 'DD-MMMM-YYYY';
				else if (d == 'D MONTH, YYYY') return 'D MMMM, YYYY';
				else if (d == 'DD MONTH, YYYY') return 'DD MMMM, YYYY';
				else return d;
			}

			function selectAll(v) {
				var checkboxes = jQuery('.cbdata');
				if (v.checked) {
					for (var i = 0; i < checkboxes.length; i++) {
						if (!checkboxes[i].disabled) {
							checkboxes[i].checked = true;
						}
					}
				} else {
					for (var i = 0; i < checkboxes.length; i++) {
						checkboxes[i].checked = false;
					}
				}
				updateHeaderValues();
			}

			function updateHeaderValues() {
				var checkboxes = jQuery('.cbdata');
				var count = 0;
				var amount = 0;
				for (var i = 0; i < checkboxes.length; i++) {
					if (checkboxes[i].checked) {
						count++;
						var cbAmount = $('#amt_' + $('#' + checkboxes[i].id).data('internalid')).val();
						amount += Number(cbAmount);
					}
				}

				$('#refundcount').html(numeral(count).format('0,0'));
				$('#refundamount').html(numeral(amount).format('$0,0.00'));
			}

			function resetForm() {
				//Unselect filters
				$('#startdate').val('');
				$('#enddate').val('');
				$('#araccountFilter').val('');
				// $("#bankaccountFilter").val("");
				$('#paymentmethodFilter').val('');
				$('#categoryFilter').val('');
				$('#currencyFilter').val('');
				$('#locationFilter').val('');

				//Reload
				reload();
			}

			function downloadCSV() {
				var ns = loadModules();
				var today = moment();
				var userRole = ns.runtime.getCurrentUser().role;

				try {
					if (ns.runtime.getCurrentScript().getRemainingUsage() < 50) {
						var myMsg = ns.message.create({
							title: 'ERROR - Governance Units has exceeded limit',
							message: 'Refresh Page. If issue persists, contact your administrator.',
							type: ns.message.Type.ERROR,
						});

						myMsg.show();
						return;
					}

					var checkboxes = jQuery('.cbdata');
					var internalids = [];
					for (var i = 0; i < checkboxes.length; i++) {
						if (checkboxes[i].checked) {
							internalids.push($('#' + checkboxes[i].id).data('internalid'));
						}
					}

					var searchParams = {
						startdate: $('#startdate').val(),
						enddate: $('#enddate').val(),
						araccountFilter: $('#araccountFilter').val(),
						bankaccountFilter: $('#bankaccountFilter').val(),
						paymentmethodFilter: $('#paymentmethodFilter').val(),
						categoryFilter: $('#categoryFilter').val(),
						currencyFilter: $('#currencyFilter').val(),
						locationFilter: $('#locationFilter').val(),
						internalids: internalids,
					};

					searchParams.searchid = '{{basesavedsearch}}'; //878; //'

					var link = ns.url.resolveScript({
						scriptId: 'customscript_ica_erefunds_service',
						deploymentId: 'customdeploy_ica_erefunds_service',
						returnExternalUrl: true,
						params: {
							action: 'downloadcsv',
							filters: JSON.stringify(searchParams),
						},
					});

					jQuery('#spinnerreload').show();

					ns.https.get
						.promise({
							url: link,
						})
						.then(function (response) {
							var win = window.open(response.body, '_blank');
							win.focus();
							jQuery('#spinnerreload').hide();
						});
				  } catch (e) {
            ns.message.create({
              title: 'UNEXPECTED ERROR OCCURRED',
              message: 'Refresh Page. If issue persists, contact your administrator.',
              type: ns.message.Type.ERROR,
            });
          }
			}

			function checkMaxValue(v) {
				var currValue = Number(jQuery('#' + v.id).val());
				var maxValue = jQuery('#' + v.id).data('max');

				if (currValue > maxValue || currValue < 0) {
					var ns = loadModules();
					ns.dialog.alert({
						title: 'Invalid Amount',
						message: 'Amount needs to be more than zero and less than maximum amount(' + maxValue + ')',
					});
					jQuery('#' + v.id).val(maxValue);
				}
			}

			function reload() {
				try {
					var ns = loadModules();
					var userRole = ns.runtime.getCurrentUser().role;

					if (ns.runtime.getCurrentScript().getRemainingUsage() < 50) {
						var myMsg = ns.message.create({
							title: 'ERROR - Governance Units has exceeded limit',
							message: 'Refresh Page. If issue persists, contact your administrator.',
							type: ns.message.Type.ERROR,
						});

						myMsg.show();
						return;
					}

					console.log('here');

					var searchParams = {
						startdate: $('#startdate').val(),
						enddate: $('#enddate').val(),
						araccountFilter: $('#araccountFilter').val(), //.find(":selected").data('internalid'),
						bankaccountFilter: $('#bankaccountFilter').val(), //.find(":selected").data('internalid'),
						categoryFilter: $('#categoryFilter').val(), //.find(":selected").data('internalid'),
						paymentmethodFilter: $('#paymentmethodFilter').val(),
						currencyFilter: $('#currencyFilter').val(), //.find(":selected").data('internalid'),
						locationFilter: $('#locationFilter').val(), //.find(":selected").data('internalid'),
					};

					searchParams.searchid = '{{basesavedsearch}}'; //878; //'{{basesavedsearch}}';

					console.log(searchParams);

					var link = ns.url.resolveScript({
						scriptId: 'customscript_ica_erefunds_service',
						deploymentId: 'customdeploy_ica_erefunds_service',
						params: {
							action: 'getResultsJSON',
							filters: JSON.stringify(searchParams),
						},
					});

					$('#data').html('<tr><td colspan="12"><i  class="fa fa-cog fa-spin fa-fw fa-2x"></i></td></tr>');

					ns.https.get
						.promise({
							url: link,
						})
						.then(function (response) {
							if ($.fn.DataTable.isDataTable('#erefunds')) {
								$('#erefunds').DataTable().clear().destroy();
							}

							//Update body.
							var data = JSON.parse(response.body);
							console.log(data);
							console.log(data.length);

							var bodyhtml = ``;
							for (var i = 0; i < data.length; i++) {
								var d = data[i];
                var c = d.Currency || '';
                var pm = '';
                if (d['Payment Method']) {
                  pm = d['Payment Method'].text;
                }
                var balance = '';
                if (d.balance) {
                  balance = d.balance.id;
                } 
								bodyhtml += `
                                                        <tr>
							<th scope="row"><input id="cb_${d['Internal ID'].id}" class="cbdata" type="checkbox" data-internalid="${d['Internal ID'].id}" data-tranid="${d.tranid.id}" onclick="updateHeaderValues()" /></th>
							<td>${d.Date.id}</td>
							<td>${d.Type.text}</td>
							<td>${pm}</td>
							<td style="text-align: center;"><a href="${d.entityurl}" target="_blank">${d['Customer Name'].text}</a></td>
							<td><a href="${d.txnurl}" target="_blank">${d.tranid.id}</a></td>
							<td>${d['Memo (Main)'].id}</td>
							<td>${c}</td>
                                                        <td>${balance}</td>
                                                        
							<td><input disabled class="form-control form-control-sm input-size" type="number" data-max="${d.Amount.id}" id="amt_${d['Internal ID'].id}" onchange="checkMaxValue(this); updateHeaderValues()" value="${d.Amount.id}" /></td>
						        </tr>
                                                        `;
							}
							if (data.length == 0) {
								bodyhtml += `
                                                        <tr>
                                                        <th scope="row"></th>
							<td rowspan="9">No Results.</td>
						        </tr>
                                                        `;
							}
              //<td>${d.consolidatebalance}</td>
							console.log(bodyhtml);
							$('#data').html(bodyhtml);

							$('#erefunds').DataTable();
						});
				} catch (e) {}
			}
		</script>
	</body>
</html>
